{% extends "base.html" %}
{% load static %}
{% block title %}{{ step.lesson.title }} · Paso {{ step.order }}{% endblock %}

{% block head %}
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
/* ====== Viewer ====== */
.step-viewer-page .viewer-wrap{
  position:relative;
  width:100%;
  aspect-ratio:16/9;
  background:#fff;
  border-radius:12px;
  box-shadow:0 8px 16px rgba(0,0,0,.08);
  overflow:hidden;
}
.step-viewer-page .viewer-toolbar{
  position:absolute; inset:10px auto auto 10px;
  z-index:2; display:flex; gap:8px;
}

/* ====== Botones generales ====== */
.step-viewer-page .btn,
.step-viewer-page .nav-btn{
  cursor:pointer;
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #9657d0;
  background:#9657d0;
  color:#fff;
  font-weight:600;
  text-decoration:none;
}
.step-viewer-page .btn:hover,
.step-viewer-page .nav-btn:hover{ background:#681db4 }

/* ====== Layout página ====== */
.step-viewer-page .page{
  display:grid;
  grid-template-columns:300px 1fr;
  gap:16px;
}
.step-viewer-page .sidebar{ position:sticky; top:16px }

/* ====== Cards ====== */
.step-viewer-page .card{
  background:#c8aef8;
  border:1px solid #c475cd;
  border-radius:12px;
  padding:12px;
}
.step-viewer-page .step-list{ list-style:none; padding:0; margin:0 }
.step-viewer-page .step-list li.active a{ font-weight:700; color:#fff }

/* ====== navegación inferior (izq / der) ====== */
.step-viewer-page .bottom-nav{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:16px;
  margin-top:12px;
}
.step-viewer-page .bottom-nav .nav-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:12px 16px;
  border-radius:14px;
  border:1px solid #9657d0;
  background:#9657d0;
  color:#fff;
  font-weight:700;
  text-decoration:none;
  min-width:180px;
}

/* ====== Responsive (PLUS) ====== */
@media (max-width:1100px){
  .step-viewer-page .page{ grid-template-columns:1fr }
  .step-viewer-page .sidebar{ position:static }
}
@media (max-width:700px){
  .step-viewer-page .bottom-nav{
    flex-direction:column;
    align-items:stretch;
  }
  .step-viewer-page .bottom-nav .nav-btn{
    width:100%;
    min-width:0;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="step-viewer-page">
  <div class="page">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="card">
        <h3>{{ step.lesson.title }}</h3>
        <p>{{ step.lesson.summary }}</p>
        <hr>
        <ol class="step-list">
          {% for s in steps %}
            <li class="{% if s.pk == step.pk %}active{% endif %}">
              <a href="{% url 'step_viewer' s.pk %}">
                {{ s.order }}. {{ s.title }}
              </a>
            </li>
          {% endfor %}
        </ol>
        <hr>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          {% if prev_step %}<a class="btn" href="{% url 'step_viewer' prev_step.pk %}">← Anterior</a>{% endif %}
          {% if next_step %}<a class="btn" href="{% url 'step_viewer' next_step.pk %}">Siguiente →</a>{% endif %}
        </div>
      </div>
    </aside>

    <!-- CONTENIDO -->
    <section>
      <h1>{{ step.order }}. {{ step.title }}</h1>

      {# ==========================================================
         RECURSO PRINCIPAL (prioridad):
         1) YouTube si la descripción contiene link
         2) step.asset.static_path -> PDF o GLB
         ========================================================== #}

      {% with step.description|default:""|lower as desc %}
        {% if step.description and "youtube.com" in desc or step.description and "youtu.be" in desc %}
          <!-- VIDEO YOUTUBE (link guardado en Description) -->
          <div class="viewer-wrap">
            <iframe
              id="ytFrame"
              data-youtube-url="{{ step.description|escapejs }}"
              title="Video del paso"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
              style="width:100%;height:100%;border:0">
            </iframe>
          </div>

          <script>
            (function(){
              const iframe = document.getElementById("ytFrame");
              if(!iframe) return;

              const raw = iframe.dataset.youtubeUrl || "";
              function getYouTubeId(url){
                try{
                  const u = new URL(url);

                  // youtu.be/<id>
                  if (u.hostname.includes("youtu.be")){
                    const id = u.pathname.replace("/", "").trim();
                    return id || null;
                  }

                  // youtube.com/watch?v=<id>
                  const v = u.searchParams.get("v");
                  if (v) return v;

                  // youtube.com/embed/<id>
                  if (u.pathname.includes("/embed/")){
                    const parts = u.pathname.split("/embed/");
                    return (parts[1] || "").split("/")[0] || null;
                  }

                  return null;
                }catch(e){
                  return null;
                }
              }

              const id = getYouTubeId(raw);
              if(!id){
                iframe.replaceWith(document.createTextNode("No se pudo leer el link de YouTube. Revisa que sea un link válido (youtube.com o youtu.be)."));
                return;
              }

              iframe.src = "https://www.youtube.com/embed/" + id;
            })();
          </script>

        {% elif step.asset and step.asset.static_path %}
          {% with step.asset.static_path|lower as f %}
            {% if f|slice:"-4:" == ".pdf" %}
              <!-- PDF -->
              <div class="viewer-wrap">
                <iframe
                  src="{% static step.asset.static_path %}#view=FitH"
                  style="width:100%;height:100%;border:0">
                </iframe>
              </div>
            {% else %}
              <!-- MODELO 3D -->
              <div class="viewer-wrap" id="viewerWrap">
                <div class="viewer-toolbar">
                  <button class="btn" id="btnWire" type="button">Wireframe</button>
                  <button class="btn" id="btnReset" type="button">Reset vista</button>
                </div>
                <canvas id="scene" style="width:100%;height:100%"></canvas>
              </div>
            {% endif %}
          {% endwith %}
        {% else %}
          <p>Este paso no tiene recursos asociados.</p>
        {% endif %}
      {% endwith %}

      <!-- AUDIO (con auto-play + reiniciar) -->
      <div class="card" style="margin-top:12px">
        <strong>Narración del paso</strong>
        <p style="margin:6px 0 10px">
          Escucha la explicación de este paso. Puedes activar el "Auto-play" para que inicie al abrir cada paso.
        </p>

        {% if step.audio_static_path %}
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <audio id="narration" controls style="flex:1;min-width:260px">
              <source src="{% static step.audio_static_path %}" type="audio/mpeg">
            </audio>

            <label style="display:flex;align-items:center;gap:8px;user-select:none">
              <input type="checkbox" id="autoplayToggle">
              <span>Auto-play</span>
            </label>

            <button class="btn" type="button" id="btnRestartAudio">Reiniciar audio</button>
          </div>

          <script>
            (function(){
              const audio = document.getElementById("narration");
              const toggle = document.getElementById("autoplayToggle");
              const btn = document.getElementById("btnRestartAudio");

              const KEY = "folearn_autoplay";
              const saved = localStorage.getItem(KEY);
              toggle.checked = saved === "1";

              toggle.addEventListener("change", () => {
                localStorage.setItem(KEY, toggle.checked ? "1" : "0");
              });

              btn.addEventListener("click", () => {
                audio.currentTime = 0;
                audio.play().catch(()=>{});
              });

              if (toggle.checked) {
                setTimeout(() => audio.play().catch(()=>{}), 300);
              }
            })();
          </script>
        {% else %}
          <p style="margin:8px 0 0">Aún no hay audio para este paso.</p>
        {% endif %}
      </div>

      <!-- navegación inferior (izq / der) -->
      <div class="bottom-nav">
        <div>
          {% if prev_step %}
            <a class="nav-btn" href="{% url 'step_viewer' prev_step.pk %}">← Paso anterior</a>
          {% endif %}
        </div>
        <div>
          {% if next_step %}
            <a class="nav-btn" href="{% url 'step_viewer' next_step.pk %}">Paso siguiente →</a>
          {% endif %}
        </div>
      </div>

      <!-- Descripción SIEMPRE visible -->
      <div class="card" style="margin-top:14px">
        <strong>Descripción:</strong>

        {% if step.description %}
          <p style="white-space:pre-line;margin-top:8px">{{ step.description }}</p>
        {% else %}
          <p style="white-space:pre-line;margin-top:8px;opacity:.85">
            (Aquí irá el texto de apoyo del audio.)
          </p>
        {% endif %}
      </div>

      {% if step.asset and step.asset.static_path %}
        {% with step.asset.static_path|lower as f %}
          {% if f|slice:"-4:" != ".pdf" %}
          <!-- THREE.JS (solo cuando hay canvas) -->
          <script type="module">
            import * as THREE from "three";
            import { OrbitControls } from "three/addons/controls/OrbitControls.js";
            import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

            const wrap = document.getElementById("viewerWrap");
            const canvas = document.getElementById("scene");

            if (!wrap || !canvas) {
              // No hay 3D en este paso (ej. YouTube)
            } else {
              const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
              renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

              const scene = new THREE.Scene();
              scene.background = new THREE.Color(0xffffff);

              const camera = new THREE.PerspectiveCamera(55, 16/9, 0.01, 1000);
              camera.position.set(3,2,3);

              const controls = new OrbitControls(camera, renderer.domElement);
              controls.enableDamping = true;

              scene.add(new THREE.HemisphereLight(0xffffff, 0x222222, 1));
              const dir = new THREE.DirectionalLight(0xffffff, 1);
              dir.position.set(3,4,5);
              scene.add(dir);

              function fit(){
                const r = wrap.getBoundingClientRect();
                renderer.setSize(r.width, r.height, false);
                camera.aspect = r.width / r.height;
                camera.updateProjectionMatrix();
              }
              new ResizeObserver(fit).observe(wrap);
              fit();

              const loader = new GLTFLoader();
              const clock = new THREE.Clock();

              let mixer = null;
              let root = null;
              let cam0 = null, tgt0 = null;

              loader.load(
                "{% static step.asset.static_path %}",
                (gltf)=>{
                  root = gltf.scene;
                  scene.add(root);

                  const box = new THREE.Box3().setFromObject(root);
                  const s = box.getBoundingSphere(new THREE.Sphere());

                  controls.target.copy(s.center);
                  camera.position.copy(s.center).add(
                    new THREE.Vector3(1,1,1).multiplyScalar(s.radius*2)
                  );

                  camera.near = 0.01;
                  camera.far = s.radius * 10;
                  camera.updateProjectionMatrix();
                  controls.update();

                  cam0 = camera.position.clone();
                  tgt0 = controls.target.clone();

                  if (gltf.animations && gltf.animations.length) {
                    mixer = new THREE.AnimationMixer(root);
                    const action = mixer.clipAction(gltf.animations[0]);
                    action.reset();
                    action.play();
                  }
                },
                undefined,
                (err)=>{
                  console.error("Error cargando GLB:", err);
                }
              );

              const btnWire = document.getElementById("btnWire");
              const btnReset = document.getElementById("btnReset");

              if (btnWire) {
                btnWire.onclick = ()=>{
                  if(!root) return;
                  root.traverse(o=>{
                    if(o.isMesh && o.material) o.material.wireframe = !o.material.wireframe;
                  });
                };
              }

              if (btnReset) {
                btnReset.onclick = ()=>{
                  if(!cam0) return;
                  camera.position.copy(cam0);
                  controls.target.copy(tgt0);
                  controls.update();
                };
              }

              function animate(){
                requestAnimationFrame(animate);
                const dt = clock.getDelta();
                if (mixer) mixer.update(dt);
                controls.update();
                renderer.render(scene, camera);
              }
              animate();
            }
          </script>
          {% endif %}
        {% endwith %}
      {% endif %}

    </section>
  </div>
</div>
{% endblock %}