{% extends "base.html" %}

{% block title %}{{ asset.title }}{% endblock %}
{% block head %}
<style>
  #scene { width:100%; height:70vh; display:block; background:#111; }
</style>

<!-- Import map: mapea "three" al CDN oficial -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>
{% endblock %}

{% block content %}
  <h2>{{ asset.title }}</h2>
  <p>{{ asset.description }}</p>
  <canvas id="scene"></canvas>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

    // Renderer
    const canvas = document.getElementById("scene");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

    // Scene & Camera
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);
    const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000);
    camera.position.set(2.5, 1.5, 3.5);

    // Resize
    function resize() {
      const w = canvas.clientWidth;
      const h = canvas.clientHeight;
      if (canvas.width !== w || canvas.height !== h) {
        renderer.setSize(w, h, false);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
      }
    }
    resize();
    window.addEventListener("resize", resize);

    // Luz básica
    scene.add(new THREE.AmbientLight(0xffffff, 1.0));
    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(5, 5, 5);
    scene.add(dir);

    // Controles
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // Cargar modelo GLTF/GLB desde MEDIA (ruta guardada en BD)
    const loader = new GLTFLoader();
    const url = "{{ asset.file.url }}";
    loader.load(url, (gltf) => {
      const root = gltf.scene;
      scene.add(root);

            // Centrar y NORMALIZAR tamaño del modelo
      const box = new THREE.Box3().setFromObject(root);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());

      // Escala uniforme para que todos tengan tamaño similar
      const maxAxis = Math.max(size.x, size.y, size.z);
      const scale = 5 / maxAxis; // ← controla qué tan grande se ve
      root.scale.setScalar(scale);

      // Recalcular centro tras escalar
      box.setFromObject(root);
      box.getCenter(center);
      root.position.sub(center);

      // Cámara FIJA (clave para consistencia)
      controls.target.set(0, 0, 0);
      camera.position.set(3, 2, 4);
      camera.near = 0.1;
      camera.far = 100;
      camera.updateProjectionMatrix();
      controls.update();
    });

    // Animación
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
{% endblock %}
